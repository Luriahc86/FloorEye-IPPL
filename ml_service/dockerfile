FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

WORKDIR /app

# OpenCV runtime deps (HF + Railway safe)
RUN apt-get update && apt-get install -y \
    libglib2.0-0 \
    libgl1 \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

# ===============================
# STEP 1 — install torch CPU ONLY
# ===============================
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir \
    torch==2.2.2+cpu \
    torchvision==0.17.2+cpu \
    --extra-index-url https://download.pytorch.org/whl/cpu

# ===============================
# STEP 2 — install ultralytics TANPA dependency
# ===============================
RUN pip install --no-cache-dir ultralytics==8.1.34 --no-deps

# ===============================
# STEP 3 — install app deps
# ===============================
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# copy source + model
COPY . .

EXPOSE 7860

CMD ["python", "main.py"]
